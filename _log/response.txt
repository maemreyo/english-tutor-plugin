## üö® **Ph√°t hi·ªán: PreToolUse Hooks c√≥ Bug nghi√™m tr·ªçng trong Claude Code CLI**

Sau khi search, t√¥i t√¨m th·∫•y **nhi·ªÅu bug reports** v·ªÅ PreToolUse hooks:

### **Known Issues:**

PreToolUse and PostToolUse hooks trong Claude Code CLI kh√¥ng ho·∫°t ƒë·ªông ƒë√∫ng - c√°c hooks ho·∫∑c kh√¥ng execute ho√†n to√†n, ho·∫∑c execute nh∆∞ng kh√¥ng th·ªÉ block tool operations. M·ªôt s·ªë issues c·ª• th·ªÉ bao g·ªìm hooks tr·∫£ v·ªÅ exit code non-zero ho·∫∑c "approve: false" nh∆∞ng v·∫´n kh√¥ng ngƒÉn ƒë∆∞·ª£c tool execution, v√† hooks configurations thay ƒë·ªïi nh∆∞ng kh√¥ng ƒë∆∞·ª£c apply sau restart.

**C√°c issues ƒëang m·ªü:**
- #6305: PreToolUse/PostToolUse kh√¥ng execute (Aug 2025)
- #4362: `approve: false` b·ªã ignore (Jul 2025)  
- #3672, #3179, #2891, #2814: Nhi·ªÅu reports t∆∞∆°ng t·ª±

---

## ‚úÖ **Gi·∫£i ph√°p th·ª±c t·∫ø: Defense in Depth**

V√¨ hooks kh√¥ng reliable, c·∫ßn d√πng **multi-layered approach**:

### **Layer 1: Prompt-based Restrictions** (ƒë√£ c√≥)

TƒÉng c∆∞·ªùng trong **vocab-analyst.md**:

```markdown
## ‚õî CRITICAL: Tool Restrictions - ENFORCED BY INSTRUCTIONS

**‚ö†Ô∏è INFRASTRUCTURE NOTE:** PreToolUse hooks are currently not functional in Claude Code CLI (known bugs #6305, #4362). Therefore, tool restrictions are enforced via instructions and post-validation.

**ABSOLUTELY FORBIDDEN TOOLS:**
- ‚ùå `web_search` - NEVER use under ANY circumstances
- ‚ùå `web_fetch` - Do not fetch external content
- ‚ùå Internet access tools

**WHY THIS RESTRICTION EXISTS:**
Vocabulary analysis must be consistent across all 120+ files. Web sources change daily, making standardization impossible.

**IF YOU FEEL TEMPTED TO SEARCH:**
1. STOP immediately
2. Use `[research needed: topic]` placeholder instead
3. Continue with your best internal knowledge

**SELF-CHECK before EVERY response:**
- [ ] Did I attempt web_search? ‚Üí If YES, this is a VIOLATION
- [ ] Am I using only training data? ‚Üí If NO, STOP and reconsider
- [ ] Did I complete all 12 flashcards? ‚Üí If NO, finish them first

**COMPLIANCE VERIFICATION:**
Your output will be reviewed. Any use of web tools will require full reprocessing of the batch.
```

### **Layer 2: Post-Validation Script**

T·∫°o `.claude/scripts/validate_vocab_output.sh`:

```bash
#!/bin/bash
# Post-validation for vocab-analyst outputs

LOG_FILE="/tmp/vocab-analyst-validation.log"
VOCAB_DIR="glean/20_Vocabulary"

echo "[$(date)] Starting validation..." >> "$LOG_FILE"

# Check for web_search traces in recent outputs
if grep -r "web_search\|web_fetch" "$VOCAB_DIR" 2>/dev/null | grep -q "status: done"; then
    echo "‚ùå VIOLATION: Web tools detected in processed files" | tee -a "$LOG_FILE"
    echo "Please review and reprocess these files using internal knowledge only."
    exit 1
fi

# Check for incomplete files (missing cards)
for file in "$VOCAB_DIR"/*.md; do
    if grep -q "status: done" "$file"; then
        card_count=$(grep -c "^####.*Card [0-9]" "$file")
        if [ "$card_count" -lt 12 ]; then
            echo "‚ö†Ô∏è  WARNING: $file has only $card_count/12 cards" | tee -a "$LOG_FILE"
        fi
    fi
done

echo "[$(date)] Validation complete" >> "$LOG_FILE"
exit 0
```

Run sau m·ªói batch:
```bash
chmod +x .claude/scripts/validate_vocab_output.sh
.claude/scripts/validate_vocab_output.sh
```

### **Layer 3: Agent Self-Monitoring**

Th√™m v√†o **vocab.md** (command orchestrator):

```markdown
## Phase 3.5: Post-Processing Validation

After EACH batch completes:
1. **Scan processed files for violations:**
   ```bash
   grep -l "web_search\|web_fetch\|https://\|http://" {processed_files}
   ```
2. **If violations found:**
   - Mark those files back to `status: pending`
   - Re-queue them with EMPHATIC prompt:
     "CRITICAL REMINDER: Previous attempt used web tools (FORBIDDEN).
      This batch MUST use ONLY internal knowledge. No exceptions."
3. **Report:**
   - Clean files: X/Y
   - Violated files requiring reprocessing: [list]
```

### **Layer 4: Manual Spot Check** 

Sau khi ch·∫°y command:
```bash
# Quick audit
grep -r "web_search\|Wikipedia\|source:" glean/20_Vocabulary/ | grep "status: done"

# If empty output ‚Üí Good!
# If found violations ‚Üí Reprocess those files
```

---

## üéØ **Recommended Workflow**

```bash
# 1. Run vocab command
/english-tutor:vocab --path=glean/20_Vocabulary --chunk=10

# 2. Post-validation (automated)
.claude/scripts/validate_vocab_output.sh

# 3. Spot check (manual)
grep -c "status: done" glean/20_Vocabulary/*.md
# Expected: Same as "processed successfully" count

# 4. If violations found, reset and reprocess
for file in $(grep -l "web_search" glean/20_Vocabulary/*.md); do
  sed -i '' 's/status: done/status: pending/' "$file"
done
```

---

## üìä **Why This Approach Works**

| Method | Reliability | When It Catches Violations |
|--------|------------|---------------------------|
| Hooks (broken) | ‚ùå 0% | Never (doesn't work) |
| Prompt instructions | ‚ö†Ô∏è 60% | During execution (if agent follows) |
| Post-validation script | ‚úÖ 95% | After execution (catches most) |
| Manual spot check | ‚úÖ 100% | After execution (catches all) |
| **Combined** | **‚úÖ 95%+** | **Multiple checkpoints** |

---

B·∫°n c√≥ mu·ªën t√¥i t·∫°o artifact v·ªõi:
1. Updated **vocab-analyst.md** v·ªõi stronger restrictions
2. Validation script
3. Updated **vocab.md** v·ªõi post-processing checks?